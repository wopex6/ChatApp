<!DOCTYPE html>
<html>
<head>
    <title>Personality Assessment Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        .question-card { background: #f5f5f5; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .option { margin: 10px 0; padding: 15px; background: white; border-radius: 6px; cursor: pointer; border: 2px solid #ddd; transition: all 0.2s; }
        .option:hover { background: #e3f2fd; border-color: #2196f3; }
        .option.selected { background: #4caf50; border: 3px solid #2e7d32; font-weight: bold; color: white; box-shadow: 0 3px 8px rgba(76, 175, 80, 0.4); transform: scale(1.02); }
        .progress { background: #ddd; height: 20px; border-radius: 10px; margin: 20px 0; }
        .progress-bar { background: #4caf50; height: 100%; border-radius: 10px; transition: width 0.3s; }
        button { background: #2196f3; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 10px 5px; }
        button:hover { background: #1976d2; }
        .feedback { background: #e8f5e9; padding: 15px; border-radius: 4px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>üß† Personality Assessment</h1>
    <div id="content">
        <div class="question-card">
            <h2>Loading...</h2>
            <p>Checking for saved progress...</p>
        </div>
    </div>

    <script>
        // Get logged-in user's username
        let currentUser = null;
        
        // First, try to get from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const usernameParam = urlParams.get('username');
        
        if (usernameParam && usernameParam !== 'unknown') {
            currentUser = usernameParam;
            console.log('‚úÖ Using username from URL parameter:', currentUser);
        } else {
            // Try to get from main app's currentUser in localStorage
            const storedUser = localStorage.getItem('currentUser');
            if (storedUser) {
                try {
                    const userData = JSON.parse(storedUser);
                    currentUser = userData.username;
                    console.log('‚úÖ Using logged-in username from localStorage:', currentUser);
                } catch (e) {
                    console.error('Error parsing currentUser:', e);
                }
            }
        }
        
        // Fallback to assessment_user_id if not logged in (shouldn't happen)
        if (!currentUser) {
            currentUser = localStorage.getItem('assessment_user_id');
            if (!currentUser) {
                currentUser = 'test_user_' + Date.now();
                localStorage.setItem('assessment_user_id', currentUser);
            }
            console.log('‚ö†Ô∏è Using fallback user ID:', currentUser);
        }
        
        let currentQuestion = null;
        let questionHistory = [];  // Track question history for back button

        // Check for existing session on page load
        window.addEventListener('DOMContentLoaded', checkExistingSession);
        
        async function checkExistingSession() {
            try {
                const response = await fetch(`/personality/assessment/question/${currentUser}`);
                const data = await response.json();
                
                if (data.ui_type === 'assessment_complete') {
                    // Assessment already completed - show completion screen
                    displayResults(data);
                } else if (data.ui_type === 'assessment_question') {
                    // Session exists! Show resume screen
                    const currentNum = parseInt(data.progress.split('/')[0]);
                    
                    if (currentNum > 1) {
                        // Has actual progress - show resume option
                        showResumeOption(data.progress);
                    } else {
                        // On question 1 - show welcome with resume option
                        showWelcomeScreen(true, data.progress);
                    }
                } else {
                    // No session - show normal welcome
                    showWelcomeScreen(false);
                }
            } catch (error) {
                console.log('No existing session found');
                showWelcomeScreen(false);
            }
        }
        
        function showWelcomeScreen(hasSession = false, progress = null) {
            const resumeButton = hasSession ? `<button onclick="resumeAssessment()">üìù Resume Assessment (${progress})</button>` : '';
            
            document.getElementById('content').innerHTML = `
                <div class="question-card">
                    <h2>üß† Personality Assessment</h2>
                    <p>This assessment will help me understand your communication preferences and adapt my responses to better suit your style.</p>
                    <p><strong>Time needed:</strong> 3-5 minutes</p>
                    <p><strong>Questions:</strong> 49 questions</p>
                    <p><strong>Benefits:</strong></p>
                    <ul>
                        <li>‚ú® More personalized AI responses</li>
                        <li>üí¨ Better communication style matching</li>
                        <li>üìà Improved learning experience</li>
                        <li>üéØ Customized interaction patterns</li>
                    </ul>
                    ${resumeButton}
                    <button onclick="startAssessment()">${hasSession ? 'üÜï Start New Assessment' : '‚ñ∂Ô∏è Start Assessment'}</button>
                    <button onclick="handleMaybeLater()">‚è≠Ô∏è Maybe Later</button>
                </div>
            `;
        }
        
        function showResumeOption(progress) {
            document.getElementById('content').innerHTML = `
                <div class="question-card">
                    <h2>üëã Welcome Back!</h2>
                    <p>You have a paused assessment at <strong>${progress}</strong></p>
                    <p>Would you like to continue where you left off, or start a new assessment?</p>
                    <button onclick="resumeAssessment()">üìù Resume Assessment</button>
                    <button onclick="startNewAssessment()">üÜï Start New Assessment</button>
                    <button onclick="handleMaybeLater()">‚è≠Ô∏è Maybe Later</button>
                </div>
            `;
        }
        
        function resumeAssessment() {
            getNextQuestion();
        }
        
        function startNewAssessment() {
            if (confirm('This will delete your current progress and start from the beginning. Are you sure?')) {
                // Create new user ID
                currentUser = 'test_user_' + Date.now();
                localStorage.setItem('assessment_user_id', currentUser);
                startAssessment();
            }
        }

        async function startAssessment() {
            try {
                const response = await fetch('/personality/assessment/start', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({user_id: currentUser})
                });
                
                const data = await response.json();
                console.log('Assessment started:', data);
                
                // Get first question
                getNextQuestion();
                
            } catch (error) {
                console.error('Error starting assessment:', error);
                document.getElementById('content').innerHTML = '<p>Error starting assessment. Please try again.</p>';
            }
        }

        async function getNextQuestion() {
            try {
                const response = await fetch(`/personality/assessment/question/${currentUser}`);
                const data = await response.json();
                
                if (data.ui_type === 'assessment_question') {
                    displayQuestion(data);
                } else if (data.ui_type === 'assessment_complete') {
                    displayResults(data);
                } else {
                    console.log('Assessment response:', data);
                }
                
            } catch (error) {
                console.error('Error getting question:', error);
            }
        }

        function displayQuestion(questionData) {
            currentQuestion = questionData;
            
            // Get current question number
            const currentNum = parseInt(questionData.progress.split('/')[0]);
            const showBackButton = currentNum > 1;
            const selectedOption = questionData.selected_option;
            
            const html = `
                <div class="question-card">
                    <div class="progress">
                        <div class="progress-bar" style="width: ${(questionData.progress.split('/')[0] / questionData.progress.split('/')[1]) * 100}%"></div>
                    </div>
                    <p><strong>Progress:</strong> ${questionData.progress}</p>
                    
                    <h3>${questionData.question}</h3>
                    
                    <div id="options">
                        ${questionData.options.map((option, index) => `
                            <div class="option ${selectedOption === index ? 'selected' : ''}" onclick="selectOption(${index})">
                                ${option.text}
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-top: 20px;">
                        ${showBackButton ? '<button onclick="goBack()" style="background: #6c757d;">‚Üê Back</button>' : ''}
                        <button onclick="pauseAssessment()">Pause Assessment</button>
                    </div>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
        }
        
        async function goBack() {
            try {
                const response = await fetch(`/personality/assessment/back/${currentUser}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.ui_type === 'assessment_question') {
                    displayQuestion(data);
                } else {
                    console.error('Error going back:', data);
                }
            } catch (error) {
                console.error('Error going back:', error);
            }
        }

        async function selectOption(optionIndex) {
            try {
                const response = await fetch('/personality/assessment/respond', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUser,
                        question_id: currentQuestion.question_id,
                        option_id: optionIndex
                    })
                });
                
                const data = await response.json();
                
                if (data.ui_type === 'assessment_question') {
                    displayQuestion(data);
                } else if (data.ui_type === 'assessment_complete') {
                    displayResults(data);
                } else {
                    console.log('Response result:', data);
                }
                
            } catch (error) {
                console.error('Error submitting response:', error);
            }
        }

        function displayResults(resultsData) {
            const profile = resultsData.profile_summary;
            
            const html = `
                <div class="question-card" style="max-width: 900px;">
                    <h2 style="text-align: center; color: #4caf50; font-size: 2.5rem;">üéâ Assessment Complete!</h2>
                    <p style="text-align: center; font-size: 1.2rem; margin: 20px 0;">${resultsData.message}</p>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 12px; color: white; margin: 30px 0;">
                        <h3 style="text-align: center; margin-bottom: 20px;">üìä Analyzing Your Responses...</h3>
                        <div style="background: white; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div id="analysis-progress" style="width: 0%; height: 100%; background: #4caf50; transition: width 2s;"></div>
                        </div>
                        <p id="analysis-text" style="text-align: center; margin-top: 10px; font-size: 0.9rem;">Processing your personality profile...</p>
                    </div>
                    
                    <div id="results-content" style="display: none;">
                        <div class="feedback" style="background: #f0f8ff; padding: 25px; border-radius: 12px; margin: 20px 0;">
                            <h3 style="color: #667eea; margin-bottom: 20px;">üß¨ Your Personality Profile</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                    <strong style="color: #667eea;">üí¨ Communication Style</strong>
                                    <p style="font-size: 1.1rem; margin-top: 5px;">${profile.communication_style}</p>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                                    <strong style="color: #4caf50;">üìö Learning Preference</strong>
                                    <p style="font-size: 1.1rem; margin-top: 5px;">${profile.learning_preference}</p>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                                    <strong style="color: #ff9800;">üéØ Goal Orientation</strong>
                                    <p style="font-size: 1.1rem; margin-top: 5px;">${profile.goal_orientation}</p>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #e91e63;">
                                    <strong style="color: #e91e63;">‚úÖ Profile Confidence</strong>
                                    <p style="font-size: 1.1rem; margin-top: 5px;">${profile.confidence_level}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 12px; margin: 20px 0;">
                            <h4 style="color: #2e7d32; margin-bottom: 15px;">üöÄ What's Next?</h4>
                            <ul style="list-style: none; padding: 0;">
                                ${resultsData.next_steps.map(step => `
                                    <li style="padding: 10px; margin: 5px 0; background: white; border-radius: 6px; border-left: 3px solid #4caf50;">
                                        ‚úì ${step}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div style="text-align: center; margin-top: 30px;">
                            <button onclick="goBackToDashboard()" style="background: #667eea;">üöÄ Okay, let's go!</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('content').innerHTML = html;
            
            // Animate the analysis process
            setTimeout(() => {
                document.getElementById('analysis-progress').style.width = '100%';
                document.getElementById('analysis-text').textContent = 'Analyzing communication patterns...';
            }, 100);
            
            setTimeout(() => {
                document.getElementById('analysis-text').textContent = 'Identifying learning preferences...';
            }, 800);
            
            setTimeout(() => {
                document.getElementById('analysis-text').textContent = 'Calculating personality traits...';
            }, 1500);
            
            setTimeout(() => {
                document.getElementById('analysis-text').textContent = 'Generating insights...';
            }, 2200);
            
            setTimeout(() => {
                document.getElementById('analysis-text').textContent = '‚úÖ Analysis complete!';
            }, 2800);
            
            // Show results after animation
            setTimeout(() => {
                document.getElementById('results-content').style.display = 'block';
                document.getElementById('results-content').scrollIntoView({ behavior: 'smooth' });
            }, 3500);
        }

        async function viewFullProfile() {
            try {
                const response = await fetch(`/personality/profile/${currentUser}`);
                const data = await response.json();
                console.log('Full profile:', data);
                
                // Display full profile (you can enhance this)
                alert('Full profile logged to console. Check developer tools.');
                
            } catch (error) {
                console.error('Error getting profile:', error);
            }
        }

        function goToConversations() {
            // Navigate to chatchat and set tab to conversations
            window.location.href = '/chatchat?tab=chat';
        }

        function goBackToDashboard() {
            // Notify parent window to refresh psychology data
            if (window.opener && !window.opener.closed) {
                try {
                    // Tell parent window to reload psychology data
                    window.opener.postMessage({ type: 'assessment_completed', username: currentUser }, '*');
                } catch (e) {
                    console.log('Could not notify parent window:', e);
                }
            }
            
            // Close window if opened as popup, otherwise navigate to psychology page
            window.close();
            
            // If window.close() didn't work (window not opened by script), navigate to psychology page
            setTimeout(() => {
                window.location.href = '/chatchat?tab=psychology';
            }, 100);
        }

        function goToDashboard() {
            // Navigate to chatchat main dashboard
            window.location.href = '/chatchat';
        }

        async function pauseAssessment() {
            // Save pause state on backend
            try {
                await fetch(`/personality/assessment/pause/${currentUser}`, {
                    method: 'POST'
                });
            } catch (error) {
                console.error('Error pausing assessment:', error);
            }
            
            // Try to close the window
            window.close();
            
            // If window.close() doesn't work (not opened by script), go back
            setTimeout(() => {
                window.history.back();
            }, 100);
        }

        function handleMaybeLater() {
            // Try to close the window
            window.close();
            
            // If window.close() doesn't work, go back
            setTimeout(() => {
                window.history.back();
            }, 100);
        }
    </script>
</body>
</html>
